# 弱點掃描報告（最終版）

日期：2026-02-05
目標：
- http://localhost:1090（前端 React/Vite）
- http://localhost:1091（後端 FastAPI）

範圍：授權深度測試（本機環境）

## 結論摘要
已修復主要風險：
- 後端改為驗證 Firebase ID Token（非本機不接受 `X-User-ID`）
- SEO 內容改為 HTML escape
- `/api/admin/users` 限制為管理員
- `public-personas` 改為僅回傳有公開腳本的 persona
- 加入速率限制與基本安全性 Header
- 前端移除 `dangerouslySetInnerHTML`，改為安全白名單渲染

目前無新增的高風險弱點。

## 已修復項目
1. **身份冒用（Critical）**
   - 以前：僅靠 `X-User-ID`，可任意冒用
   - 現在：需 `Authorization: Bearer <id_token>` 驗證
   - 本機測試才可開 `ALLOW_X_USER_ID=1`

2. **SEO Stored XSS（High）**
   - 以前：標題與描述未完整 escape
   - 現在：全面 HTML escape

3. **管理端查詢未限制（Medium）**
   - 以前：任何登入者可查 `/api/admin/users`
   - 現在：僅 `ADMIN_USER_IDS` 可用

4. **Public Personas 過度暴露（Medium）**
   - 以前：回傳所有 persona
   - 現在：僅回傳有公開腳本的 persona

5. **速率限制 / 安全 Header（Low/Medium）**
   - 新增：
     - `/api/analysis/script/{id}`：30/min
     - `/api/export/all`：5/min
     - `/api/search`：60/min
   - Header：CSP（寬鬆）、X-Frame-Options、X-Content-Type-Options、Referrer-Policy

6. **前端 HTML 注入風險（Low）**
   - 移除 `dangerouslySetInnerHTML`
   - 改為白名單安全渲染（限定 tag/class/style）

## 仍需注意
- 需以「真實登入 token」做一次 `/api/health/auth` 驗證
- `ALLOW_X_USER_ID` 僅限本機/測試，正式環境必須關閉
- CSP 為寬鬆版（符合現況，但防護較弱）

